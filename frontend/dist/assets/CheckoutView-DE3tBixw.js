const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/address-BWcCuitd.js","assets/index-D7KbY98F.js","assets/index-CNnu_hxC.css"])))=>i.map(i=>d[i]);
import{_ as C,d as l,e,h as p,f as r,l as m,g as A,t as c,F as g,s as k,n as y,i as h,G as _,M as v,v as P,w as b,A as M,H as S,u as T,p as a,k as w}from"./index-D7KbY98F.js";import{p as I,h as N,g as D}from"./address-BWcCuitd.js";const x={name:"CheckoutView",setup(){const i=S(),s=T();return{cartStore:i,userStore:s}},data(){return{orderItems:[],orderType:"cart",addresses:[],selectedAddress:null,showAddressSelector:!1,deliveryMethod:"standard",couponCode:"",appliedCoupon:null,couponMessage:"",couponMessageType:"info",showPaymentDialog:!1,paymentStatus:"waiting",selectedPaymentMethod:"wechat",paymentTimeLeft:600,paymentTimer:null,orderId:null,loading:!1}},computed:{totalItems(){return this.orderItems.reduce((i,s)=>i+s.quantity,0)},subtotal(){return this.orderItems.reduce((i,s)=>i+s.price*s.quantity,0)},deliveryFee(){return this.deliveryMethod==="express"?15:0},totalAmount(){let i=this.subtotal+this.deliveryFee;return this.appliedCoupon&&(i-=this.appliedCoupon.discount),Math.max(0,i)},canCheckout(){return this.selectedAddress&&this.orderItems.length>0}},async mounted(){await this.initCheckout()},methods:{async initCheckout(){try{this.loading=!0,await this.loadOrderItems(),await this.loadAddresses(),this.selectDefaultAddress()}catch(i){console.error("初始化结算页面失败:",i),this.showNotification("加载失败，请重试")}finally{this.loading=!1}},async loadOrderItems(){const i=this.$route.query;if(i.type==="direct"&&i.productId){this.orderType="direct";const s=JSON.parse(i.product||"{}");this.orderItems=[{id:s.id,name:s.name,image:s.image,price:s.price,spec:s.selectedSpec||"",quantity:parseInt(i.quantity)||1}]}else{this.orderType="cart",this.cartStore.cartItems.length===0&&await this.cartStore.loadCart();const s=this.cartStore.cartItems.filter(u=>u.selected);this.orderItems=s.map(u=>({id:u.productId,name:u.name,image:u.image,price:u.price,spec:u.spec,quantity:u.quantity}))}this.orderItems.length===0&&(this.showNotification("没有要结算的商品"),this.$router.push("/user-center"))},async loadAddresses(){try{const i=await D();i.success&&(this.addresses=i.data)}catch(i){console.error("获取地址列表失败:",i)}},selectDefaultAddress(){const i=this.addresses.find(s=>s.isDefault);i?this.selectedAddress=i:this.addresses.length>0&&(this.selectedAddress=this.addresses[0])},selectAddress(i){this.selectedAddress=i},confirmAddressSelection(){this.closeAddressSelector()},closeAddressSelector(){this.showAddressSelector=!1},addNewAddress(){this.$router.push("/user-center?tab=address")},async applyCoupon(){if(!this.couponCode.trim()){this.showCouponMessage("请输入优惠券代码","error");return}const s={WELCOME10:{name:"新用户优惠券",discount:10},SAVE20:{name:"满减优惠券",discount:20},VIP50:{name:"VIP专享券",discount:50}}[this.couponCode.toUpperCase()];s?(this.appliedCoupon=s,this.couponCode="",this.showCouponMessage("优惠券使用成功","success")):this.showCouponMessage("优惠券代码无效","error")},removeCoupon(){this.appliedCoupon=null,this.showCouponMessage("已移除优惠券","info")},showCouponMessage(i,s){this.couponMessage=i,this.couponMessageType=s,setTimeout(()=>{this.couponMessage=""},3e3)},async proceedToPayment(){if(!this.canCheckout){this.showNotification("请完善订单信息");return}try{this.loading=!0;const i={items:this.orderItems,addressId:this.selectedAddress.id,deliveryMethod:this.deliveryMethod,couponCode:this.appliedCoupon?.name,totalAmount:this.totalAmount};console.log("创建订单数据:",JSON.stringify(i,null,2));const s=await N(i);s.success?(this.orderId=s.data.orderId,this.showPaymentDialog=!0,this.paymentStatus="waiting",this.startPaymentTimer()):this.showNotification("创建订单失败："+s.message)}catch(i){console.error("创建订单失败:",i),this.showNotification("创建订单失败，请重试")}finally{this.loading=!1}},confirmPayment(){this.processPayment()},async processPayment(){try{const i=await I(this.orderId,this.selectedPaymentMethod);i.success?(this.paymentStatus="success",this.stopPaymentTimer(),this.orderType==="cart"&&await this.cartStore.clearSelectedItems(),setTimeout(()=>{this.showNotification("支付成功！")},1e3)):this.showNotification("支付失败："+i.message)}catch(i){console.error("支付失败:",i),this.showNotification("支付失败，请重试")}},getPaymentMethodName(i){return{wechat:"微信",alipay:"支付宝",unionpay:"银联"}[i]||"微信"},startPaymentTimer(){this.paymentTimeLeft=600,this.paymentTimer=setInterval(()=>{this.paymentTimeLeft--,this.paymentTimeLeft<=0&&this.stopPaymentTimer()},1e3)},stopPaymentTimer(){this.paymentTimer&&(clearInterval(this.paymentTimer),this.paymentTimer=null)},formatTime(i){const s=Math.floor(i/60),u=i%60;return`${s.toString().padStart(2,"0")}:${u.toString().padStart(2,"0")}`},async cancelPayment(){if(this.stopPaymentTimer(),this.paymentTimeLeft>0)if(confirm(`是否要取消订单？
选择"确定"将取消订单
选择"取消"将保留订单，稍后可继续支付`)&&this.orderId)try{const{cancelOrder:s}=await M(async()=>{const{cancelOrder:f}=await import("./address-BWcCuitd.js").then(o=>o.o);return{cancelOrder:f}},__vite__mapDeps([0,1,2])),u=await s(this.orderId);u.success?this.showNotification("订单已取消"):this.showNotification("订单取消失败："+u.message)}catch(s){console.error("取消订单失败:",s),this.showNotification("取消订单失败，请重试")}else this.showNotification("支付已取消，订单保留中");else this.showNotification("支付已超时取消");this.showPaymentDialog=!1},closePaymentDialog(){this.paymentStatus==="success"?this.goToOrderDetail():this.showPaymentDialog=!1},goToOrderDetail(){this.$router.push("/user-center?tab=orders")},showNotification(i){alert(i)}}},V={class:"checkout-page"},q={class:"container"},O={class:"page-header"},F={class:"checkout-content"},L={class:"checkout-main"},U={class:"checkout-section"},E={class:"section-header"},B={key:0,class:"address-card selected"},J={class:"address-info"},R={class:"recipient-info"},z={class:"name"},G={class:"phone"},H={key:0,class:"default-tag"},W={class:"address-detail"},j={key:1,class:"no-address"},K={class:"checkout-section"},Q={class:"section-header"},X={class:"item-count"},Y={class:"product-list"},Z={class:"product-image"},$=["src","alt"],ss={class:"product-info"},es={key:0},ts={class:"product-meta"},os={class:"price"},is={class:"quantity"},ns={class:"item-total"},ds={class:"checkout-section"},as={class:"section-header"},ls={class:"delivery-options"},rs={class:"checkout-section"},cs={class:"section-header"},ps={class:"coupon-section"},us={class:"coupon-input"},ms={key:0,class:"applied-coupon"},ys={class:"discount"},hs={class:"checkout-sidebar"},vs={class:"order-summary"},fs={class:"summary-details"},gs={class:"summary-row"},ks={class:"summary-row"},_s={key:0,class:"summary-row discount"},bs={class:"summary-row total"},ws={class:"total-price"},Cs=["disabled"],As={class:"payment-security"},Ps={class:"dialog-header"},Ms={class:"dialog-content"},Ss={key:0,class:"no-addresses"},Ts={key:1,class:"address-list"},Is=["onClick"],Ns={class:"address-info"},Ds={class:"recipient-info"},xs={class:"name"},Vs={class:"phone"},qs={key:0,class:"default-tag"},Os={class:"address-detail"},Fs={class:"dialog-actions"},Ls={class:"dialog-header"},Us={class:"payment-content compact-content"},Es={class:"payment-summary"},Bs={class:"order-info"},Js={class:"order-number"},Rs={class:"payment-amount"},zs={class:"amount-value"},Gs={key:0,class:"payment-main"},Hs={class:"payment-methods-section"},Ws={class:"payment-options compact-options"},js={class:"payment-icon wechat"},Ks={class:"payment-icon alipay"},Qs={class:"payment-icon unionpay"},Xs={class:"qr-code-section compact-qr"},Ys={class:"qr-code"},Zs={class:"qr-instruction"},$s={key:0,class:"warning-text"},se={key:1,class:"payment-success"},ee={class:"success-icon"},te={key:2,class:"payment-tips compact-tips"},oe={class:"tips-content"},ie={class:"payment-actions compact-actions"},ne={class:"button-group"},de=["disabled"];function ae(i,s,u,f,o,n){const d=A("Icon");return a(),l("div",V,[e("div",q,[e("div",O,[e("h1",null,[r(d,{icon:"mdi:credit-card"}),s[23]||(s[23]=m(" 确认订单 ",-1))]),s[24]||(s[24]=e("p",null,"请确认您的订单信息并选择支付方式",-1))]),e("div",F,[e("div",L,[e("div",U,[e("div",E,[e("h3",null,[r(d,{icon:"mdi:map-marker"}),s[25]||(s[25]=m(" 收货地址 ",-1))]),e("button",{class:"btn-change",onClick:s[0]||(s[0]=t=>o.showAddressSelector=!0)},[r(d,{icon:"mdi:pencil"}),s[26]||(s[26]=m(" 更换地址 ",-1))])]),o.selectedAddress?(a(),l("div",B,[e("div",J,[e("div",R,[e("span",z,c(o.selectedAddress.recipientName),1),e("span",G,c(o.selectedAddress.phone),1),o.selectedAddress.isDefault?(a(),l("span",H,"默认")):p("",!0)]),e("div",W,[r(d,{icon:"mdi:map-marker"}),m(" "+c(o.selectedAddress.fullAddress),1)])])])):(a(),l("div",j,[r(d,{icon:"mdi:map-marker-off"}),s[27]||(s[27]=e("span",null,"请选择收货地址",-1)),e("button",{class:"btn-add-address",onClick:s[1]||(s[1]=t=>o.showAddressSelector=!0)}," 添加地址 ")]))]),e("div",K,[e("div",Q,[e("h3",null,[r(d,{icon:"mdi:package-variant"}),s[28]||(s[28]=m(" 商品清单 ",-1))]),e("span",X,"共 "+c(n.totalItems)+" 件商品",1)]),e("div",Y,[(a(!0),l(g,null,k(o.orderItems,t=>(a(),l("div",{key:t.id,class:"product-item"},[e("div",Z,[t.image?(a(),l("img",{key:0,src:t.image,alt:t.name},null,8,$)):(a(),w(d,{key:1,icon:"mdi:image"}))]),e("div",ss,[e("h4",null,c(t.name),1),t.spec?(a(),l("p",es,c(t.spec),1)):p("",!0),e("div",ts,[e("span",os,"¥"+c(t.price.toFixed(2)),1),e("span",is,"x"+c(t.quantity),1)])]),e("div",ns," ¥"+c((t.price*t.quantity).toFixed(2)),1)]))),128))])]),e("div",ds,[e("div",as,[e("h3",null,[r(d,{icon:"mdi:truck"}),s[29]||(s[29]=m(" 配送方式 ",-1))])]),e("div",ls,[e("label",{class:y(["delivery-option",{active:o.deliveryMethod==="standard"}])},[h(e("input",{type:"radio","onUpdate:modelValue":s[2]||(s[2]=t=>o.deliveryMethod=t),value:"standard"},null,512),[[v,o.deliveryMethod]]),s[30]||(s[30]=_('<div class="option-content" data-v-b2cb89ca><div class="option-info" data-v-b2cb89ca><span class="option-name" data-v-b2cb89ca>标准配送</span><span class="option-desc" data-v-b2cb89ca>3-5个工作日送达</span></div><span class="option-price" data-v-b2cb89ca>免费</span></div>',1))],2),e("label",{class:y(["delivery-option",{active:o.deliveryMethod==="express"}])},[h(e("input",{type:"radio","onUpdate:modelValue":s[3]||(s[3]=t=>o.deliveryMethod=t),value:"express"},null,512),[[v,o.deliveryMethod]]),s[31]||(s[31]=_('<div class="option-content" data-v-b2cb89ca><div class="option-info" data-v-b2cb89ca><span class="option-name" data-v-b2cb89ca>快速配送</span><span class="option-desc" data-v-b2cb89ca>1-2个工作日送达</span></div><span class="option-price" data-v-b2cb89ca>¥15.00</span></div>',1))],2)])]),e("div",rs,[e("div",cs,[e("h3",null,[r(d,{icon:"mdi:tag"}),s[32]||(s[32]=m(" 优惠券 ",-1))])]),e("div",ps,[e("div",us,[h(e("input",{type:"text","onUpdate:modelValue":s[4]||(s[4]=t=>o.couponCode=t),placeholder:"请输入优惠券代码",class:"coupon-field"},null,512),[[P,o.couponCode]]),e("button",{class:"btn-apply-coupon",onClick:s[5]||(s[5]=(...t)=>n.applyCoupon&&n.applyCoupon(...t))}," 使用 ")]),o.appliedCoupon?(a(),l("div",ms,[r(d,{icon:"mdi:check-circle"}),e("span",null,c(o.appliedCoupon.name),1),e("span",ys,"-¥"+c(o.appliedCoupon.discount.toFixed(2)),1),e("button",{class:"btn-remove-coupon",onClick:s[6]||(s[6]=(...t)=>n.removeCoupon&&n.removeCoupon(...t))},[r(d,{icon:"mdi:close"})])])):p("",!0),o.couponMessage?(a(),l("div",{key:1,class:y(["coupon-message",o.couponMessageType])},c(o.couponMessage),3)):p("",!0)])])]),e("div",hs,[e("div",vs,[s[40]||(s[40]=e("h3",null,"订单汇总",-1)),e("div",fs,[e("div",gs,[s[33]||(s[33]=e("span",null,"商品总价",-1)),e("span",null,"¥"+c(n.subtotal.toFixed(2)),1)]),e("div",ks,[s[34]||(s[34]=e("span",null,"配送费用",-1)),e("span",null,c(n.deliveryFee>0?`¥${n.deliveryFee.toFixed(2)}`:"免费"),1)]),o.appliedCoupon?(a(),l("div",_s,[s[35]||(s[35]=e("span",null,"优惠券折扣",-1)),e("span",null,"-¥"+c(o.appliedCoupon.discount.toFixed(2)),1)])):p("",!0),s[37]||(s[37]=e("div",{class:"summary-divider"},null,-1)),e("div",bs,[s[36]||(s[36]=e("span",null,"应付总额",-1)),e("span",ws,"¥"+c(n.totalAmount.toFixed(2)),1)])]),e("button",{class:"btn-checkout",onClick:s[7]||(s[7]=(...t)=>n.proceedToPayment&&n.proceedToPayment(...t)),disabled:!n.canCheckout},[r(d,{icon:"mdi:credit-card"}),s[38]||(s[38]=m(" 立即支付 ",-1))],8,Cs),e("div",As,[r(d,{icon:"mdi:shield-check"}),s[39]||(s[39]=e("span",null,"支付安全保障",-1))])])])])]),o.showAddressSelector?(a(),l("div",{key:0,class:"dialog-overlay",onClick:s[13]||(s[13]=(...t)=>n.closeAddressSelector&&n.closeAddressSelector(...t))},[e("div",{class:"dialog-container",onClick:s[12]||(s[12]=b(()=>{},["stop"]))},[e("div",Ps,[s[41]||(s[41]=e("h3",null,"选择收货地址",-1)),e("button",{class:"dialog-close-btn",onClick:s[8]||(s[8]=(...t)=>n.closeAddressSelector&&n.closeAddressSelector(...t))},[r(d,{icon:"mdi:close"})])]),e("div",Ms,[o.addresses.length===0?(a(),l("div",Ss,[r(d,{icon:"mdi:map-marker-off"}),s[42]||(s[42]=e("p",null,"暂无收货地址",-1)),e("button",{class:"btn-add-address",onClick:s[9]||(s[9]=(...t)=>n.addNewAddress&&n.addNewAddress(...t))}," 添加新地址 ")])):(a(),l("div",Ts,[(a(!0),l(g,null,k(o.addresses,t=>(a(),l("div",{key:t.id,class:y(["address-option",{selected:o.selectedAddress?.id===t.id}]),onClick:le=>n.selectAddress(t)},[e("div",Ns,[e("div",Ds,[e("span",xs,c(t.recipientName),1),e("span",Vs,c(t.phone),1),t.isDefault?(a(),l("span",qs,"默认")):p("",!0)]),e("div",Os,c(t.fullAddress),1)]),o.selectedAddress?.id===t.id?(a(),w(d,{key:0,icon:"mdi:check-circle",class:"selected-icon"})):p("",!0)],10,Is))),128))]))]),e("div",Fs,[e("button",{class:"btn-cancel",onClick:s[10]||(s[10]=(...t)=>n.closeAddressSelector&&n.closeAddressSelector(...t))},"取消"),e("button",{class:"btn-confirm",onClick:s[11]||(s[11]=(...t)=>n.confirmAddressSelection&&n.confirmAddressSelection(...t))},"确认")])])])):p("",!0),o.showPaymentDialog?(a(),l("div",{key:1,class:"dialog-overlay payment-overlay",onClick:s[22]||(s[22]=(...t)=>n.closePaymentDialog&&n.closePaymentDialog(...t))},[e("div",{class:"dialog-container payment-dialog compact-payment",onClick:s[21]||(s[21]=b(()=>{},["stop"]))},[e("div",Ls,[s[43]||(s[43]=e("h3",null,"支付订单",-1)),e("button",{class:"dialog-close-btn",onClick:s[14]||(s[14]=(...t)=>n.closePaymentDialog&&n.closePaymentDialog(...t))},[r(d,{icon:"mdi:close"})])]),e("div",Us,[e("div",Es,[e("div",Bs,[s[44]||(s[44]=e("span",{class:"order-label"},"订单号：",-1)),e("span",Js,c(o.orderId),1)]),e("div",Rs,[s[45]||(s[45]=e("span",{class:"amount-label"},"支付金额",-1)),e("span",zs,"¥"+c(n.totalAmount.toFixed(2)),1)])]),o.paymentStatus==="waiting"?(a(),l("div",Gs,[e("div",Hs,[s[49]||(s[49]=e("h4",null,"支付方式",-1)),e("div",Ws,[e("label",{class:y(["payment-option compact-option",{active:o.selectedPaymentMethod==="wechat"}])},[h(e("input",{type:"radio","onUpdate:modelValue":s[15]||(s[15]=t=>o.selectedPaymentMethod=t),value:"wechat"},null,512),[[v,o.selectedPaymentMethod]]),e("div",js,[r(d,{icon:"mdi:wechat"})]),s[46]||(s[46]=e("span",null,"微信支付",-1))],2),e("label",{class:y(["payment-option compact-option",{active:o.selectedPaymentMethod==="alipay"}])},[h(e("input",{type:"radio","onUpdate:modelValue":s[16]||(s[16]=t=>o.selectedPaymentMethod=t),value:"alipay"},null,512),[[v,o.selectedPaymentMethod]]),e("div",Ks,[r(d,{icon:"simple-icons:alipay"})]),s[47]||(s[47]=e("span",null,"支付宝",-1))],2),e("label",{class:y(["payment-option compact-option",{active:o.selectedPaymentMethod==="unionpay"}])},[h(e("input",{type:"radio","onUpdate:modelValue":s[17]||(s[17]=t=>o.selectedPaymentMethod=t),value:"unionpay"},null,512),[[v,o.selectedPaymentMethod]]),e("div",Qs,[r(d,{icon:"mdi:credit-card"})]),s[48]||(s[48]=e("span",null,"银联支付",-1))],2)])]),e("div",Xs,[e("div",Ys,[r(d,{icon:"mdi:qrcode"})]),e("p",Zs," 使用"+c(n.getPaymentMethodName(o.selectedPaymentMethod))+"扫码支付 ",1),e("div",{class:y(["payment-timer compact-timer",{"timer-warning":o.paymentTimeLeft<=180}])},[r(d,{icon:"mdi:clock-outline"}),e("span",null,c(n.formatTime(o.paymentTimeLeft)),1),o.paymentTimeLeft<=180?(a(),l("span",$s,"即将超时")):p("",!0)],2)])])):p("",!0),o.paymentStatus==="success"?(a(),l("div",se,[e("div",ee,[r(d,{icon:"mdi:check-circle"})]),s[50]||(s[50]=e("h4",null,"支付成功！",-1)),s[51]||(s[51]=e("p",null,"订单已生成，我们将尽快为您处理",-1))])):p("",!0),o.paymentStatus==="waiting"?(a(),l("div",te,[e("div",oe,[r(d,{icon:"mdi:information-outline"}),s[52]||(s[52]=e("span",null,'请在10分钟内完成支付，支付完成后点击"确认已支付"',-1))])])):p("",!0),e("div",ie,[e("div",ne,[o.paymentStatus==="waiting"?(a(),l("button",{key:0,class:"btn-confirm-payment",onClick:s[18]||(s[18]=(...t)=>n.confirmPayment&&n.confirmPayment(...t)),disabled:!o.selectedPaymentMethod},[r(d,{icon:"mdi:check"}),s[53]||(s[53]=m(" 确认已支付 ",-1))],8,de)):p("",!0),o.paymentStatus==="success"?(a(),l("button",{key:1,class:"btn-view-order",onClick:s[19]||(s[19]=(...t)=>n.goToOrderDetail&&n.goToOrderDetail(...t))},[r(d,{icon:"mdi:eye"}),s[54]||(s[54]=m(" 查看订单 ",-1))])):p("",!0),o.paymentStatus==="waiting"?(a(),l("button",{key:2,class:"btn-cancel-payment",onClick:s[20]||(s[20]=(...t)=>n.cancelPayment&&n.cancelPayment(...t))},[r(d,{icon:"mdi:close"}),s[55]||(s[55]=m(" 取消支付 ",-1))])):p("",!0)])])])])])):p("",!0)])}const pe=C(x,[["render",ae],["__scopeId","data-v-b2cb89ca"]]);export{pe as default};
