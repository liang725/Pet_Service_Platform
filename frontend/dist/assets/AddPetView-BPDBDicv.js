import{y as $,_ as A,u as J,c as w,b as Y,r as y,o as j,d as v,e as t,f as i,l as u,g as z,t as c,q as I,h as f,F as P,s as C,i as g,v as b,n as _,k as H,w as K,m as Q,p as d}from"./index-D7KbY98F.js";import{u as W}from"./pet-CCxjMNZm.js";const X=()=>$({url:"/api/user/info",method:"GET"}),Z={class:"add-pet-view"},ee={class:"page-header"},te={class:"page-title"},se={class:"page-subtitle"},le={key:0,class:"loading-container"},oe={class:"loading-spinner"},ae={key:1,class:"form-container"},ne={class:"form-section"},re={class:"section-title"},ie={class:"form-grid"},ue={class:"form-group"},de={for:"petType",class:"form-label required"},ve={class:"pet-type-selector"},ce=["onClick"],pe={class:"option-label"},me={key:0,class:"error-message"},fe={class:"form-group"},ge={for:"name",class:"form-label required"},be={key:0,class:"error-message"},he={class:"form-group"},ye={for:"breed",class:"form-label"},_e={key:0,class:"error-message"},ke={class:"form-group"},we={for:"gender",class:"form-label required"},Ie={class:"gender-selector"},Ue=["onClick"],xe={class:"gender-label"},De={class:"form-section"},Te={class:"section-title"},Se={class:"form-grid"},Ve={class:"form-group"},Pe={for:"color",class:"form-label"},Ce={key:0,class:"error-message"},Ne={class:"form-group"},Le={for:"weight",class:"form-label"},Fe={key:0,class:"error-message"},Re={class:"form-group"},qe={for:"birthDate",class:"form-label"},Oe=["max","min"],Be={class:"form-section"},Ee={class:"section-title"},Me={class:"form-grid"},Ge={class:"form-group full-width"},$e={for:"personality",class:"form-label"},Ae={key:0,class:"error-message"},Je={class:"form-group full-width"},Ye={for:"notes",class:"form-label"},je={class:"form-section"},ze={class:"section-title"},He={class:"form-group full-width"},Ke={for:"avatarUrl",class:"form-label"},Qe={key:0,class:"avatar-preview"},We=["src"],Xe={class:"form-actions"},Ze=["disabled"],et=["disabled"],tt=["disabled"],st={__name:"AddPetView",setup(lt){const k=Q(),D=Y(),m=W(),r=J(),N=w(()=>D.name==="editPet"?"edit":"add"),U=y(D.params.id||null),p=w(()=>N.value==="edit"),s=y({petType:"",name:"",breed:"",gender:"未知",birthDate:"",color:"",weight:"",avatarUrl:"",personality:"",notes:""}),a=y({}),h=y(!1),L=y([{value:"猫",label:"猫咪",icon:"mdi:cat"},{value:"狗",label:"狗狗",icon:"mdi:dog"}]),F=y([{value:"公",label:"公"},{value:"母",label:"母"},{value:"未知",label:"未知"}]),R=w(()=>p.value?"编辑宠物信息":"添加新宠物"),x=()=>{if(console.log("检查登录状态 - userStore.userInfo:",r.userInfo),console.log("检查登录状态 - userStore.token:",r.token),console.log("检查登录状态 - userStore.isLoggedIn:",r.isLoggedIn),r.isLoggedIn&&r.token)return r.userInfo?.id?!0:(console.log("已登录但缺少用户信息，尝试获取"),T(),!!r.userInfo?.id);const l=localStorage.getItem("token"),e=localStorage.getItem("userRole");if(l){if(console.log("发现 localStorage 中的 token:",l),!r.token){r.token=l,r.userRole=e||"",r.isLoggedIn=!0;try{const n=l.split(".");if(n.length===3){const o=JSON.parse(atob(n[1]));console.log("从 token 中提取的用户信息:",o),o.userId&&(r.userInfo={id:o.userId,username:o.sub||"用户",role:o.role||"user"},console.log("已设置用户信息:",r.userInfo))}}catch(n){console.error("解析 token 失败:",n)}}return r.userInfo?.id||T(),!!r.userInfo?.id}return console.log("未登录，跳转到登录页面"),alert("请先登录后再操作"),k.push("/auth"),!1},T=async()=>{try{if(!r.token)return console.log("没有 token，无法获取用户信息"),!1;const l=await X();return l.code===200?(r.userInfo=l.data,r.isLoggedIn=!0,console.log("成功获取用户信息:",r.userInfo),!0):(console.log("获取用户信息失败"),!1)}catch(l){return console.error("获取用户信息失败:",l),!1}},S=async()=>{if(!(!p.value||!U.value)&&x())try{if(await m.fetchPetDetail(U.value),m.currentPet){const l=m.currentPet;s.value={petType:l.petType||"",name:l.name||"",breed:l.breed||"",gender:l.gender||"未知",birthDate:l.birthDate||"",color:l.color||"",weight:l.weight||"",avatarUrl:l.avatarUrl||"",personality:l.personality||"",notes:l.notes||""}}}catch(l){alert(l.message||"获取宠物信息失败"),k.push("/pets")}},q=()=>{a.value={};let l=!0;if(s.value.petType||(a.value.petType="请选择宠物类型",l=!1),s.value.name.trim()?s.value.name.trim().length>50&&(a.value.name="名字不能超过50个字符",l=!1):(a.value.name="请输入宠物名字",l=!1),s.value.breed&&s.value.breed.length>100&&(a.value.breed="品种不能超过100个字符",l=!1),s.value.color&&s.value.color.length>50&&(a.value.color="毛色描述不能超过50个字符",l=!1),s.value.weight){const e=parseFloat(s.value.weight);isNaN(e)||e<=0?(a.value.weight="请输入有效的体重（正数）",l=!1):e>100&&(a.value.weight="体重不能超过100kg",l=!1)}return s.value.personality&&s.value.personality.length>255&&(a.value.personality="性格描述不能超过255个字符",l=!1),l},O=async()=>{if(q()&&x()){if(!r.userInfo?.id){alert("用户信息获取失败，请重新登录"),k.push("/auth");return}console.log("提交表单 - 当前用户ID:",r.userInfo.id);try{h.value=!0;const l={petType:s.value.petType,name:s.value.name.trim(),breed:s.value.breed.trim()||null,gender:s.value.gender,birthDate:s.value.birthDate||null,color:s.value.color.trim()||null,weight:s.value.weight?parseFloat(s.value.weight):null,avatarUrl:s.value.avatarUrl.trim()||null,personality:s.value.personality.trim()||null,notes:s.value.notes.trim()||null};console.log("提交表单 - 提交数据:",l),console.log("提交表单 - 用户ID:",r.userInfo.id);let e;p.value?e=await m.updatePet(U.value,l):e=await m.addPet(l);const n=p.value?"更新宠物成功":"添加宠物成功";alert(n),k.push("/pets")}catch(l){console.error("表单提交错误:",l),alert(l.message||"提交失败，请重试"),(l.message.includes("未登录")||l.message.includes("登录"))&&k.push("/auth")}finally{h.value=!1}}},B=()=>{confirm("确定要重置表单吗？所有输入的内容都将丢失。")&&(p.value?S():(s.value={petType:"",name:"",breed:"",gender:"未知",birthDate:"",color:"",weight:"",avatarUrl:"",personality:"",notes:""},a.value={}))},V=()=>{k.push("/pets")};j(()=>{x()&&p.value&&S()});const E=y(new Date().toISOString().split("T")[0]),M=w(()=>{const l=new Date;return l.setFullYear(l.getFullYear()-30),l.toISOString().split("T")[0]});return(l,e)=>{const n=z("Icon");return d(),v("div",Z,[t("div",ee,[t("button",{onClick:V,class:"back-btn"},[i(n,{icon:"mdi:arrow-left"}),e[9]||(e[9]=u(" 返回列表 ",-1))]),t("h1",te,[i(n,{icon:p.value?"mdi:pencil":"mdi:plus-circle",class:"title-icon"},null,8,["icon"]),u(" "+c(R.value),1)]),t("p",se,c(p.value?"修改宠物的详细信息":"填写宠物的详细信息，记录它的点点滴滴"),1)]),I(m).loading&&p.value?(d(),v("div",le,[t("div",oe,[i(n,{icon:"mdi:loading",spin:""})]),e[10]||(e[10]=t("p",null,"加载宠物信息中...",-1))])):(d(),v("div",ae,[t("form",{onSubmit:K(O,["prevent"]),class:"pet-form"},[t("div",ne,[t("h2",re,[i(n,{icon:"mdi:information"}),e[11]||(e[11]=u(" 基本信息 ",-1))]),t("div",ie,[t("div",ue,[t("label",de,[i(n,{icon:"mdi:paw"}),e[12]||(e[12]=u(" 宠物类型 ",-1))]),t("div",ve,[(d(!0),v(P,null,C(L.value,o=>(d(),v("div",{key:o.value,class:_(["pet-type-option",{selected:s.value.petType===o.value}]),onClick:G=>s.value.petType=o.value},[i(n,{icon:o.icon,class:"option-icon"},null,8,["icon"]),t("span",pe,c(o.label),1)],10,ce))),128))]),a.value.petType?(d(),v("div",me,c(a.value.petType),1)):f("",!0)]),t("div",fe,[t("label",ge,[i(n,{icon:"mdi:tag"}),e[13]||(e[13]=u(" 宠物名字 ",-1))]),g(t("input",{type:"text",id:"name","onUpdate:modelValue":e[0]||(e[0]=o=>s.value.name=o),class:_(["form-input",{error:a.value.name}]),placeholder:"例如：小白、巧克力",maxlength:"50"},null,2),[[b,s.value.name]]),a.value.name?(d(),v("div",be,c(a.value.name),1)):f("",!0),e[14]||(e[14]=t("div",{class:"input-hint"},"最多50个字符",-1))]),t("div",he,[t("label",ye,[i(n,{icon:"mdi:dna"}),e[15]||(e[15]=u(" 品种 ",-1))]),g(t("input",{type:"text",id:"breed","onUpdate:modelValue":e[1]||(e[1]=o=>s.value.breed=o),class:_(["form-input",{error:a.value.breed}]),placeholder:"例如：金毛寻回犬、英国短毛猫",maxlength:"100"},null,2),[[b,s.value.breed]]),a.value.breed?(d(),v("div",_e,c(a.value.breed),1)):f("",!0),e[16]||(e[16]=t("div",{class:"input-hint"},"最多100个字符",-1))]),t("div",ke,[t("label",we,[i(n,{icon:"mdi:gender-male-female"}),e[17]||(e[17]=u(" 性别 ",-1))]),t("div",Ie,[(d(!0),v(P,null,C(F.value,o=>(d(),v("div",{key:o.value,class:_(["gender-option",{selected:s.value.gender===o.value}]),onClick:G=>s.value.gender=o.value},[t("span",xe,c(o.label),1)],10,Ue))),128))])])])]),t("div",De,[t("h2",Te,[i(n,{icon:"mdi:palette"}),e[18]||(e[18]=u(" 外观特征 ",-1))]),t("div",Se,[t("div",Ve,[t("label",Pe,[i(n,{icon:"mdi:palette"}),e[19]||(e[19]=u(" 毛色 ",-1))]),g(t("input",{type:"text",id:"color","onUpdate:modelValue":e[2]||(e[2]=o=>s.value.color=o),class:_(["form-input",{error:a.value.color}]),placeholder:"例如：白色带棕色斑点",maxlength:"50"},null,2),[[b,s.value.color]]),a.value.color?(d(),v("div",Ce,c(a.value.color),1)):f("",!0),e[20]||(e[20]=t("div",{class:"input-hint"},"最多50个字符",-1))]),t("div",Ne,[t("label",Le,[i(n,{icon:"mdi:weight"}),e[21]||(e[21]=u(" 体重 (kg) ",-1))]),g(t("input",{type:"number",id:"weight","onUpdate:modelValue":e[3]||(e[3]=o=>s.value.weight=o),class:_(["form-input",{error:a.value.weight}]),placeholder:"例如：5.5",step:"0.1",min:"0.1",max:"100"},null,2),[[b,s.value.weight]]),a.value.weight?(d(),v("div",Fe,c(a.value.weight),1)):f("",!0),e[22]||(e[22]=t("div",{class:"input-hint"},"单位：千克",-1))]),t("div",Re,[t("label",qe,[i(n,{icon:"mdi:cake"}),e[23]||(e[23]=u(" 出生日期 ",-1))]),g(t("input",{type:"date",id:"birthDate","onUpdate:modelValue":e[4]||(e[4]=o=>s.value.birthDate=o),class:"form-input",max:E.value,min:M.value},null,8,Oe),[[b,s.value.birthDate]]),e[24]||(e[24]=t("div",{class:"input-hint"},"如果不知道确切日期，可以留空",-1))])])]),t("div",Be,[t("h2",Ee,[i(n,{icon:"mdi:heart"}),e[25]||(e[25]=u(" 性格与习惯 ",-1))]),t("div",Me,[t("div",Ge,[t("label",$e,[i(n,{icon:"mdi:star"}),e[26]||(e[26]=u(" 性格特点 ",-1))]),g(t("input",{type:"text",id:"personality","onUpdate:modelValue":e[5]||(e[5]=o=>s.value.personality=o),class:_(["form-input",{error:a.value.personality}]),placeholder:"例如：活泼、温顺、胆小、粘人",maxlength:"255"},null,2),[[b,s.value.personality]]),a.value.personality?(d(),v("div",Ae,c(a.value.personality),1)):f("",!0),e[27]||(e[27]=t("div",{class:"input-hint"},"最多255个字符",-1))]),t("div",Je,[t("label",Ye,[i(n,{icon:"mdi:note-text"}),e[28]||(e[28]=u(" 特别记录 ",-1))]),g(t("textarea",{id:"notes","onUpdate:modelValue":e[6]||(e[6]=o=>s.value.notes=o),class:"form-textarea",rows:"4",placeholder:"记录宠物的特别习惯、喜好、健康情况、疫苗接种记录等"},null,512),[[b,s.value.notes]]),e[29]||(e[29]=t("div",{class:"input-hint"},"宠物的特别注意事项",-1))])])]),t("div",je,[t("h2",ze,[i(n,{icon:"mdi:image"}),e[30]||(e[30]=u(" 宠物头像 ",-1))]),t("div",He,[t("label",Ke,[i(n,{icon:"mdi:link"}),e[31]||(e[31]=u(" 头像图片URL ",-1))]),g(t("input",{type:"text",id:"avatarUrl","onUpdate:modelValue":e[7]||(e[7]=o=>s.value.avatarUrl=o),class:"form-input",placeholder:"例如：https://example.com/pet-avatar.jpg",maxlength:"255"},null,512),[[b,s.value.avatarUrl]]),e[33]||(e[33]=t("div",{class:"input-hint"},"支持JPG、PNG格式，建议尺寸：200x200像素",-1)),s.value.avatarUrl?(d(),v("div",Qe,[e[32]||(e[32]=t("div",{class:"preview-label"},"头像预览：",-1)),t("img",{src:s.value.avatarUrl,alt:"头像预览",class:"preview-image",onError:e[8]||(e[8]=o=>s.value.avatarUrl="")},null,40,We)])):f("",!0)])]),t("div",Xe,[t("button",{type:"button",onClick:V,class:"btn btn-secondary",disabled:h.value||I(m).loading}," 取消 ",8,Ze),t("button",{type:"button",onClick:B,class:"btn btn-reset",disabled:h.value||I(m).loading}," 重置 ",8,et),t("button",{type:"submit",class:"btn btn-primary",disabled:h.value||I(m).loading},[h.value?(d(),H(n,{key:0,icon:"mdi:loading",spin:""})):f("",!0),u(" "+c(h.value?"提交中...":p.value?"更新宠物":"添加宠物"),1)],8,tt)])],32)]))])}}},nt=A(st,[["__scopeId","data-v-220a0757"]]);export{nt as default};
