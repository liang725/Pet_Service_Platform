# 商品销量自动更新功能

## 功能说明

当用户购买商品并完成支付后，系统会自动更新商品的销量。

## 实现逻辑

### 1. 触发时机
- **订单支付成功时**：当订单状态从 `pending`（待支付）更新为 `paid`（已支付）时触发

### 2. 更新方式
- 遍历订单中的所有商品
- 根据每个商品的购买数量，增加对应商品的销量
- 使用 SQL: `UPDATE products SET sales = sales + #{quantity} WHERE id = #{id}`

### 3. 代码位置

#### ProductMapper.java
```java
/**
 * 增加商品销量
 */
@Update("UPDATE products SET sales = sales + #{quantity}, updated_at = NOW() WHERE id = #{id}")
int increaseSales(@Param("id") Integer id, @Param("quantity") Integer quantity);
```

#### OrderServiceImpl.java - processPayment() 方法
```java
// 支付成功后，更新商品销量
try {
    List<OrderItem> items = orderMapper.findOrderItemsByOrderId(orderId);
    for (OrderItem item : items) {
        int salesUpdated = productMapper.increaseSales(item.getProductId(), item.getQuantity());
        System.out.println("更新商品销量，商品ID: " + item.getProductId() + 
                         ", 数量: " + item.getQuantity() + 
                         ", 更新结果: " + salesUpdated);
    }
} catch (Exception e) {
    System.err.println("更新商品销量失败: " + e.getMessage());
    // 销量更新失败不影响支付流程，只记录日志
}
```

## 测试步骤

### 1. 查看商品初始销量
```sql
SELECT id, name, sales FROM products WHERE id = 1;
```

### 2. 用户购买商品
- 登录用户账号
- 将商品加入购物车
- 提交订单（假设购买数量为 2）
- 完成支付

### 3. 验证销量更新
```sql
-- 销量应该增加 2
SELECT id, name, sales FROM products WHERE id = 1;
```

### 4. 查看后端日志
支付成功后应该看到类似日志：
```
支付处理成功，订单状态已更新为paid
更新商品销量，商品ID: 1, 数量: 2, 更新结果: 1
```

## 注意事项

1. **销量更新失败不影响支付**：即使销量更新失败，支付流程仍然会成功完成，只会在日志中记录错误
2. **原子性**：销量更新使用 `sales = sales + quantity` 的方式，避免并发问题
3. **只在支付成功时更新**：创建订单时不更新销量，只有支付成功后才更新

## 相关文件

- `pet/backend/src/main/java/com/ddliang/backend/mapper/ProductMapper.java`
- `pet/backend/src/main/java/com/ddliang/backend/service/impl/OrderServiceImpl.java`
- `pet/backend/src/main/java/com/ddliang/backend/controller/OrderController.java`
